{% extends "base.html" %}

{% block title %}Turnos · Peluquería Ivon{% endblock %}

{% block content %}
<section class="hero">
    <div>
        <div class="hero-badge">
            <div class="dot"></div>
            Agenda de turnos · {{ month_name }} {{ year }}
        </div>

        <h1 class="hero-title">Turnos Peluquería Ivon</h1>
        <p class="hero-sub">
            Tocá un día del calendario para ver los turnos de esa fecha.
            En computadora tenés el formulario a la derecha.
            En celular lo vas a ver dentro de la ventana del día.
        </p>
    </div>
</section>

<div class="cal-container">
    <!-- Calendario -->
    <div class="calendar">
        <div class="cal-header">
            <a href="?year={{ prev_year }}&month={{ prev_month }}" class="cal-nav-btn">&lsaquo;</a>
            <span class="cal-title">{{ month_name }} {{ year }}</span>
            <a href="?year={{ next_year }}&month={{ next_month }}" class="cal-nav-btn">&rsaquo;</a>
        </div>

        <table class="cal">
            <thead>
                <tr>
                    <th>Lun</th>
                    <th>Mar</th>
                    <th>Mié</th>
                    <th>Jue</th>
                    <th>Vie</th>
                    <th>Sáb</th>
                    <th>Dom</th>
                </tr>
            </thead>
            <tbody>
            {% for week in weeks %}
                <tr>
                    {% for day in week %}
                        {% if day %}
                            <td class="day" data-fecha="{{ day.date }}">
                                {{ day.num }}
                            </td>
                        {% else %}
                            <td class="empty"></td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if puede_editar %}
    <!-- Panel formulario (solo PC, en celu se oculta con CSS) -->
    <aside class="panel-form">
        <h2>Registrar nuevo turno</h2>
        <form method="post">
            {% csrf_token %}
            <label for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}</label>
            {{ form.nombre }}

            <label for="{{ form.desc.id_for_label }}">{{ form.desc.label }}</label>
            {{ form.desc }}

            <label for="{{ form.fecha.id_for_label }}">{{ form.fecha.label }}</label>
            {{ form.fecha }}

            <label for="{{ form.hora.id_for_label }}">{{ form.hora.label }}</label>
            {{ form.hora }}

            <label for="{{ form.sena.id_for_label }}">{{ form.sena.label }}</label>
            {{ form.sena }}

            <button type="submit">Guardar turno</button>
        </form>
    </aside>
    {% endif %}
</div>

<!-- Modal turnos por día -->
<div class="modal-backdrop" id="modal-turnos">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modal-title">Turnos</div>
            <button class="modal-close" id="btn-close-modal">&times;</button>
        </div>

        <div id="modal-body"></div>

        {% if puede_editar %}
        <!-- Botón para mostrar formulario (útil en celu) -->
        <button type="button" class="btn-modal-register" id="btn-open-form-modal">
            Registrar nuevo turno para este día
        </button>

        <!-- Formulario dentro del modal (celu) -->
        <div id="modal-form-container" class="modal-form">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="fecha" id="modal-fecha-input">

                <label for="modal-nombre">Nombre del cliente</label>
                <input id="modal-nombre" name="nombre" type="text" required>

                <label for="modal-desc">Servicio / nota</label>
                <textarea id="modal-desc" name="desc"></textarea>

                <label for="modal-hora">Hora</label>
                <input id="modal-hora" name="hora" type="time" required>

                <label for="modal-sena">Seña ($)</label>
                <input id="modal-sena" name="sena" type="number" step="0.01" value="0">

                <button type="submit">Guardar turno</button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<script>
    const TURNOS = JSON.parse(`{{ turnos_json|escapejs }}`);

    const modal = document.getElementById('modal-turnos');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
    const btnClose = document.getElementById('btn-close-modal');

    const inputFechaLateral = document.querySelector('input[name="fecha"]');
    const modalFechaInput   = document.getElementById('modal-fecha-input');
    const btnOpenFormModal  = document.getElementById('btn-open-form-modal');
    const modalFormContainer = document.getElementById('modal-form-container');

    // marcar días y setear eventos
    document.querySelectorAll('td.day').forEach(td => {
        const fecha = td.dataset.fecha;

        if (TURNOS[fecha]) {
            td.classList.add('has-turnos');
        }

        td.addEventListener('click', () => {
            if (inputFechaLateral) inputFechaLateral.value = fecha;
            if (modalFechaInput)   modalFechaInput.value   = fecha;

            mostrarTurnosDia(fecha);
        });
    });

    function mostrarTurnosDia(fecha) {
        const lista = TURNOS[fecha] || [];
        modalTitle.textContent = `Turnos para ${fecha.split('-').reverse().join('/')}`;
        modalBody.innerHTML = '';

        if (lista.length === 0) {
            const p = document.createElement('p');
            p.className = 'turno-empty';
            p.textContent = 'No hay turnos registrados para este día.';
            modalBody.appendChild(p);
        } else {
            lista.forEach(t => {
                const div = document.createElement('div');
                div.className = 'turno-item';

                const desc = t.desc || '';
                let senaTexto = '';
                if (t.sena && t.sena > 0) {
                    senaTexto = `Seña: $${t.sena.toFixed ? t.sena.toFixed(2) : t.sena}`;
                }

                div.innerHTML = `
                    <strong>${t.hora}</strong> · ${t.nombre}<br>
                    <span>${desc}</span><br>
                    <span>${senaTexto}</span>
                `;
                modalBody.appendChild(div);
            });
        }

        if (modalFormContainer) modalFormContainer.style.display = 'none';
        if (btnOpenFormModal) btnOpenFormModal.style.display = 'block';

        modal.classList.add('show');
    }

    if (btnOpenFormModal && modalFormContainer) {
        btnOpenFormModal.addEventListener('click', () => {
            modalFormContainer.style.display = 'block';
            btnOpenFormModal.style.display = 'none';
        });
    }

    btnClose.addEventListener('click', () => {
        modal.classList.remove('show');
    });

    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('show');
        }
    });
</script>
{% endblock content %}
